<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>#176 Worker 隔離執行 - Web Workers 範例</title>
    <meta name="description" content="展示如何使用 Web Worker 建立隔離的執行環境，安全地執行使用者輸入的程式碼">
    <link rel="stylesheet" href="../../01-computation/001-prime-generator/style.css">
    <style>
        .code-editor {
            width: 100%;
            height: 200px;
            background-color: var(--bg-input);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            resize: vertical;
            margin-bottom: 15px;
        }
        .code-editor:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .console-output {
            background-color: #000;
            color: #0f0;
            padding: 15px;
            border-radius: var(--border-radius);
            font-family: var(--font-mono);
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .console-line {
            margin-bottom: 5px;
            border-bottom: 1px solid #333;
            padding-bottom: 2px;
        }
        .console-line.error {
            color: #ff5555;
        }
        .console-line.warn {
            color: #ffb86c;
        }
        .console-line.info {
            color: #8be9fd;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        .status-running {
            background-color: var(--warning-color);
            color: #000;
        }
        .status-idle {
            background-color: var(--success-color);
            color: #fff;
        }
        .status-terminated {
            background-color: var(--danger-color);
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Worker 隔離執行</h1>
            <p class="subtitle">Isolated Execution Environment</p>
            <div class="badge-container">
                <span class="badge badge-primary">#176</span>
                <span class="badge badge-secondary">任務分流</span>
                <span class="badge badge-danger">高級</span>
            </div>
        </header>

        <section class="card">
            <h2 class="card-title">程式碼沙箱</h2>
            <p class="result-note">在這裡輸入 JavaScript 程式碼。程式碼將在隔離的 Web Worker 中執行，主頁面不會受到影響。</p>

            <div class="form-group">
                <label class="form-label">執行策略配置</label>
                <div class="input-row">
                    <div>
                        <label class="form-label" for="timeout-input">超時限制 (ms)</label>
                        <input type="number" id="timeout-input" class="form-input" value="1000" min="100" max="10000">
                    </div>
                    <div>
                        <label class="form-label" for="whitelist-input">允許的全局變數 (逗號分隔)</label>
                        <input type="text" id="whitelist-input" class="form-input" value="Math,Date,console" placeholder="例如: Math,Date">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">JavaScript 程式碼</label>
                <textarea id="code-input" class="code-editor" spellcheck="false">// 範例：計算費波那契數列 (故意寫一個耗時操作)
function fib(n) {
  if (n <= 1) return n;
  return fib(n - 1) + fib(n - 2);
}

// 嘗試計算第 35 項
console.log("開始計算...");
const start = Date.now();
const result = fib(35);
const end = Date.now();
console.log(`結果: ${result}`);
console.log(`耗時: ${end - start}ms`);

// 嘗試存取禁止的變數 (例如 window 或 document)
try {
  console.log("嘗試存取 window:", typeof window);
} catch (e) {
  console.error(e.message);
}
</textarea>
            </div>

            <div class="btn-group">
                <button id="run-btn" class="btn btn-primary">執行程式碼</button>
                <button id="terminate-btn" class="btn btn-danger" disabled>強制終止</button>
                <button id="clear-btn" class="btn btn-secondary">清除輸出</button>
                <span id="worker-status" class="status-badge status-idle">閒置中</span>
            </div>
        </section>

        <section class="card">
            <h2 class="card-title">執行輸出</h2>
            <div id="console-output" class="console-output"></div>
        </section>

        <section class="card info-section">
            <h3>關於隔離執行</h3>
            <ul>
                <li><strong>沙箱環境：</strong>Worker 提供了一個獨立的執行環境，無法直接存取 DOM 或主執行緒的變數。</li>
                <li><strong>安全限制：</strong>透過限制 Worker 內的全局作用域 (Scope)，可以防止程式碼存取敏感 API。</li>
                <li><strong>資源控制：</strong>可以設定執行超時，若程式碼執行過久 (例如無窮迴圈)，主執行緒可以強制終止 Worker。</li>
                <li><strong>錯誤處理：</strong>Worker 內的錯誤會被捕獲並傳回主執行緒，不會導致整個應用程式崩潰。</li>
            </ul>
        </section>

        <footer class="footer">
            <p>
                <a href="../../../">Awesome Web Workers Examples 1000</a>
                &nbsp;|&nbsp;
                範例 #176 - Worker 隔離執行
            </p>
        </footer>
    </div>

    <script src="main.js"></script>
</body>
</html>
