# 220 èƒŒå£“æ§åˆ¶ Backpressure Control

<p align="center">
  <span class="badge badge-danger">ğŸ”´ é«˜ç´š</span>
  <span class="badge badge-primary">Dedicated Worker</span>
  <span class="badge badge-secondary">é€šè¨Šå”èª¿</span>
</p>

## åŠŸèƒ½èªªæ˜

æ­¤ç¯„ä¾‹å±•ç¤ºå¦‚ä½•åœ¨ Web Worker ä¸­å¯¦ç¾**èƒŒå£“æ§åˆ¶ (Backpressure Control)** æ©Ÿåˆ¶ã€‚ç•¶è¨Šæ¯ç™¼é€é€Ÿåº¦è¶…é Worker çš„è™•ç†èƒ½åŠ›æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•è§¸ç™¼èƒŒå£“æ©Ÿåˆ¶ï¼Œæš«åœç™¼é€ä»¥é˜²æ­¢è¨Šæ¯éè¼‰ã€‚

### æ ¸å¿ƒæ¦‚å¿µ

- **èƒŒå£“ (Backpressure)**ï¼šç•¶æ¥æ”¶ç«¯è™•ç†é€Ÿåº¦è·Ÿä¸ä¸Šç™¼é€ç«¯æ™‚ï¼Œéœ€è¦åå‘æ–½å£“è®“ç™¼é€ç«¯æ¸›é€Ÿ
- **é«˜æ°´ä½é–¾å€¼**ï¼šç·©è¡å€ä½¿ç”¨é‡é”åˆ°æ­¤é–¾å€¼æ™‚è§¸ç™¼èƒŒå£“
- **ä½æ°´ä½é–¾å€¼**ï¼šç·©è¡å€ä½¿ç”¨é‡é™è‡³æ­¤é–¾å€¼æ™‚è§£é™¤èƒŒå£“

## æŠ€è¡“è¦æ ¼

| é …ç›® | èªªæ˜ |
|------|------|
| Worker é¡å‹ | Dedicated Worker |
| é€šè¨Šæ–¹å¼ | postMessage |
| æµé‡æ§åˆ¶ | é«˜/ä½æ°´ä½é–¾å€¼èƒŒå£“ |
| ç·©è¡å€é¡å‹ | FIFO ä½‡åˆ— |
| è¨Šæ¯è™•ç† | éåŒæ­¥æ¨¡æ“¬å»¶é² |

## æª”æ¡ˆçµæ§‹

```
220-backpressure-control/
â”œâ”€â”€ index.html    # ä¸»é é¢
â”œâ”€â”€ main.js       # ä¸»åŸ·è¡Œç·’è…³æœ¬
â”œâ”€â”€ worker.js     # Worker è…³æœ¬
â”œâ”€â”€ style.css     # æ¨£å¼è¡¨
â””â”€â”€ README.md     # èªªæ˜æ–‡ä»¶
```

## ä½¿ç”¨æ–¹å¼

1. è¨­å®šè¨Šæ¯ç™¼é€é€Ÿç‡ï¼ˆæ¯ç§’ç™¼é€å¤šå°‘å‰‡è¨Šæ¯ï¼‰
2. è¨­å®š Worker è™•ç†æ™‚é–“ï¼ˆæ¨¡æ“¬æ¯å‰‡è¨Šæ¯çš„è™•ç†å»¶é²ï¼‰
3. è¨­å®šç·©è¡å€å¤§å°å’Œé«˜æ°´ä½é–¾å€¼
4. é»æ“Šã€Œé–‹å§‹æ¨¡æ“¬ã€è§€å¯ŸèƒŒå£“æ§åˆ¶è¡Œç‚º

## é€šè¨Šå”è­°

### ä¸»åŸ·è¡Œç·’ â†’ Worker

```javascript
// è¨­å®šåƒæ•¸
{ type: 'CONFIGURE', payload: { processTime, bufferSize, highWatermark } }

// é–‹å§‹è™•ç†
{ type: 'START' }

// åœæ­¢è™•ç†
{ type: 'STOP' }

// ç™¼é€è¨Šæ¯
{ type: 'MESSAGE', payload: { id, data, timestamp } }

// é‡ç½®çµ±è¨ˆ
{ type: 'RESET' }
```

### Worker â†’ ä¸»åŸ·è¡Œç·’

```javascript
// ç·©è¡å€ç‹€æ…‹
{ type: 'BUFFER_STATUS', payload: { usage, capacity, percent, isHighWater, isLowWater } }

// è¨Šæ¯è™•ç†å®Œæˆ
{ type: 'PROCESSED', payload: { id, latency, totalProcessed } }

// è¨Šæ¯ä¸Ÿæ£„
{ type: 'DROPPED', payload: { id, totalDropped } }

// æ—¥èªŒè¨Šæ¯
{ type: 'LOG', payload: { level, message, timestamp } }
```

## èƒŒå£“æ§åˆ¶æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸»åŸ·è¡Œç·’                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    è¨Šæ¯ç™¼é€    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ç™¼é€å™¨  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚             â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚   Worker    â”‚        â”‚
â”‚       â†‘                     â”‚   ç·©è¡å€    â”‚        â”‚
â”‚       â”‚                     â”‚             â”‚        â”‚
â”‚  èƒŒå£“ä¿¡è™Ÿ                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  (æš«åœ/æ¢å¾©)                       â”‚                â”‚
â”‚       â”‚                           â”‚                â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç‹€æ…‹å›å ± â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         (é«˜æ°´ä½/ä½æ°´ä½)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é—œéµç¨‹å¼ç¢¼

### èƒŒå£“åˆ¤æ–·é‚è¼¯

```javascript
// Worker ç«¯å›å ±ç·©è¡å€ç‹€æ…‹
function sendBufferStatus() {
    const usage = messageBuffer.length;
    const percent = (usage / bufferSize) * 100;

    self.postMessage({
        type: 'BUFFER_STATUS',
        payload: {
            isHighWater: percent >= highWatermark,
            isLowWater: percent <= lowWatermark
        }
    });
}

// ä¸»åŸ·è¡Œç·’ç«¯è™•ç†èƒŒå£“
function handleBufferStatus(payload) {
    if (payload.isHighWater && !isPaused) {
        pauseSending();  // è§¸ç™¼èƒŒå£“
    } else if (payload.isLowWater && isPaused) {
        resumeSending(); // è§£é™¤èƒŒå£“
    }
}
```

## åƒæ•¸èª¿æ•´å»ºè­°

| å ´æ™¯ | ç™¼é€é€Ÿç‡ | è™•ç†æ™‚é–“ | ç·©è¡å€ | é«˜æ°´ä½ |
|------|---------|---------|--------|--------|
| è¼•è² è¼‰ | 50/ç§’ | 20ms | 50 | 80% |
| ä¸­è² è¼‰ | 100/ç§’ | 50ms | 50 | 80% |
| é«˜è² è¼‰ | 200/ç§’ | 30ms | 100 | 75% |
| æ¥µé™æ¸¬è©¦ | 500/ç§’ | 10ms | 200 | 70% |

## æ•ˆèƒ½æŒ‡æ¨™

- **ååé‡**ï¼šæ¯ç§’å¯¦éš›è™•ç†çš„è¨Šæ¯æ•¸
- **ä¸Ÿæ£„ç‡**ï¼šè¢«ä¸Ÿæ£„çš„è¨Šæ¯ä½”ç¸½ç™¼é€è¨Šæ¯çš„æ¯”ä¾‹
- **æš«åœæ¬¡æ•¸**ï¼šèƒŒå£“è§¸ç™¼çš„æ¬¡æ•¸

## æ‡‰ç”¨å ´æ™¯

1. **å³æ™‚è³‡æ–™ä¸²æµ**ï¼šè™•ç† WebSocket æˆ– SSE çš„é«˜é »è³‡æ–™
2. **æ—¥èªŒæ”¶é›†ç³»çµ±**ï¼šæ§åˆ¶æ—¥èªŒç™¼é€é€Ÿç‡é¿å…å¾Œç«¯éè¼‰
3. **è¨Šæ¯ä½‡åˆ—**ï¼šå¯¦ç¾å¯é çš„è¨Šæ¯å‚³éç³»çµ±
4. **é«˜é »äº¤æ˜“**ï¼šè™•ç†å¤§é‡å¸‚å ´è³‡æ–™æ›´æ–°

## ç€è¦½å™¨æ”¯æ´

- Chrome 4+
- Firefox 3.5+
- Safari 4+
- Edge 12+

## ç›¸é—œç¯„ä¾‹

- [#201 åŸºæœ¬ postMessage é€šè¨Š](../201-basic-postmessage/)
- [#221 å¿ƒè·³å”è­°](../221-heartbeat-protocol/)
- [#222 é‡é€£æ©Ÿåˆ¶](../222-reconnection-mechanism/)
- [#223 è¨Šæ¯ç¢ºèª](../223-message-acknowledgment/)

## ä¸‹ä¸€æ­¥

è©¦è©¦ [#221 å¿ƒè·³å”è­°](../221-heartbeat-protocol/)ï¼Œå­¸ç¿’å¦‚ä½•å¯¦ç¾ Worker é€£æ¥ä¿æ´»æ©Ÿåˆ¶ã€‚
